<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auslagen-Verwaltung - Gut und Aussehend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        /* Logo-optimierte Vereinsfarben - perfekt abgestimmt */
        .bg-verein-darkblue { background-color: #0A1929; }
        .bg-verein-pink { background-color: #E91E7E; }
        .bg-verein-cyan { background-color: #4FD9D9; }
        
        .text-verein-darkblue { color: #0A192F; }
        .text-verein-pink { color: #E91E7E; }
        .text-verein-cyan { color: #4FD9D9; }
        
        /* Dunklere Hover-Varianten */
        .hover\:bg-verein-pink-dark:hover { background-color: #C2185B; }
        .hover\:bg-verein-cyan-dark:hover { background-color: #26C6DA; }
        .hover\:bg-verein-darkblue-dark:hover { background-color: #061A2B; }
        
        /* Border-Varianten */
        .border-verein-pink { border-color: #E91E7E; }
        .border-verein-cyan { border-color: #4FD9D9; }
        .border-verein-darkblue { border-color: #0A1929; }
        
        /* Helle Varianten f√ºr bessere Lesbarkeit */
        .bg-verein-pink-light { background-color: #FCE4EC; }
        .bg-verein-cyan-light { background-color: #E0F7FA; }
        
        /* Perfekter Logo-Gradient */
        .bg-gradient-verein {
            background: linear-gradient(135deg, #0A1929 0%, #E91E7E 40%, #4FD9D9 100%);
        }
        
        /* Focus-Rings f√ºr Barrierefreiheit */
        .focus-verein\:ring-pink:focus { 
            --tw-ring-color: #E91E7E;
            --tw-ring-offset-width: 2px;
        }
        .focus-verein\:ring-cyan:focus { 
            --tw-ring-color: #4FD9D9;
            --tw-ring-offset-width: 2px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // Vereins-Logo als Base64
        const LOGO_BASE64 = 'logo.png';

        // App State
        let state = {
            currentUser: null,
            view: 'login',
            auslagen: [],
            toast: null,
            modal: {
                    open: false,
                    mitglied: null,
                    ausgewaehlt: []
                    },            
            formData: {
                betrag: '',
                datum: new Date().toISOString().split('T')[0],
                zweck: '',
                kategorie: 'Kost√ºme',
                beleg: null
            }
        };

        // LocalStorage Functions
        function loadData() {
            const stored = localStorage.getItem('auslagen-data');
            if (stored) {
                state.auslagen = JSON.parse(stored);
            }
        }

        function saveData() {
            localStorage.setItem('auslagen-data', JSON.stringify(state.auslagen));
        }

        // Login
        function handleLogin(name, rolle) {
            if (!name.trim()) {
                alert('Bitte Namen eingeben!');
                return;
            }
            state.currentUser = { name, rolle };
            state.view = rolle === 'kassenwart' ? 'dashboard' : 'meine-auslagen';
            render();
        }

        // Logout
        function handleLogout() {
            state.currentUser = null;
            state.view = 'login';
            render();
        }

        // Beleg Upload
        function handleBelegUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    state.formData.beleg = reader.result;
                    render();
                };
                reader.readAsDataURL(file);
            }
        }

        // Remove Beleg
        function removeBeleg() {
            state.formData.beleg = null;
            render();
        }

        // Submit Auslage
        function handleSubmit(event) {
            event.preventDefault();
            
            const neueAuslage = {
                id: Date.now(),
                mitglied: state.currentUser.name,
                betrag: parseFloat(state.formData.betrag),
                datum: state.formData.datum,
                zweck: state.formData.zweck,
                kategorie: state.formData.kategorie,
                beleg: state.formData.beleg,
                status: 'offen',
                eingereichtAm: new Date().toISOString(),
                bezahltAm: null
            };

            state.auslagen.push(neueAuslage);
            saveData();
            
            // Reset Form
            state.formData = {
                betrag: '',
                datum: new Date().toISOString().split('T')[0],
                zweck: '',
                kategorie: 'Kost√ºme',
                beleg: null
            };
            
            state.view = 'meine-auslagen';
            state.toast = 'Auslage erfolgreich eingereicht!';
            render();
        }

        // Update Status
        function updateStatus(id, newStatus) {
            const auslage = state.auslagen.find(a => a.id === id);
            if (auslage) {
                auslage.status = newStatus;
                if (newStatus === 'bezahlt') {
                    auslage.bezahltAm = new Date().toISOString();
                }
                saveData();
                render();
            }
        }

        // View Beleg
        function viewBeleg(belegData) {
            window.open(belegData, '_blank');
        }

        // Export CSV
        function exportCSV() {
            const csv = [
                ['Datum', 'Mitglied', 'Kategorie', 'Zweck', 'Betrag', 'Status', 'Eingereicht am', 'Bezahlt am'].join(';'),
                ...state.auslagen.map(a => [
                    a.datum,
                    a.mitglied,
                    a.kategorie,
                    a.zweck,
                    a.betrag.toFixed(2),
                    a.status,
                    new Date(a.eingereichtAm).toLocaleDateString('de-DE'),
                    a.bezahltAm ? new Date(a.bezahltAm).toLocaleDateString('de-DE') : ''
                ].join(';'))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'auslagen_export_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        function openBelegModal(mitglied) {
            const belegeDesMitglieds = state.auslagen.filter(
                a => a.mitglied === mitglied && (a.status === 'offen' || a.status === 'gepr√ºft')
            );
            state.modal = {
                open: true,
                mitglied: mitglied,
                belegeDesMitglieds: belegeDesMitglieds,
                ausgewaehlt: []
            };
            render();
        }

        function toggleBeleg(id) {
            const idx = state.modal.ausgewaehlt.indexOf(id);
            if (idx === -1) {
                state.modal.ausgewaehlt.push(id);
            } else {
                state.modal.ausgewaehlt.splice(idx, 1);
            }
            render();
        }

        function bezahleAusgewaehlt() {
            if (state.modal.ausgewaehlt.length === 0) {
                alert('Bitte mindestens einen Beleg ausw√§hlen!');
                return;
            }
            state.modal.ausgewaehlt.forEach(id => updateStatus(id, 'bezahlt'));
            state.modal = { open: false, mitglied: null, belegeDesMitglieds: [], ausgewaehlt: [] };
            render();
        }

        function closeModal() {
            state.modal = { open: false, mitglied: null, belegeDesMitglieds: [], ausgewaehlt: [] };
            render();
        }

        function renderToast() {
            if (!state.toast) return '';
            return `
                <div class="fixed top-6 left-1/2 -translate-x-1/2 z-50 bg-verein-darkblue text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3">
                    <span class="text-2xl">‚úÖ</span>
                    <p class="font-semibold">${state.toast}</p>
                    <button onclick="state.toast = null; render();" class="ml-4 bg-verein-pink hover:bg-verein-pink-dark px-3 py-1 rounded-lg text-sm font-semibold transition">
                        OK
                    </button>
                </div>
            `;
        }

        function renderModal() {
            if (!state.modal.open) return '';

            const summeAusgewaehlt = state.modal.ausgewaehlt
                .reduce((sum, id) => {
                    const a = state.auslagen.find(a => a.id === id);
                    return sum + (a ? a.betrag : 0);
                }, 0);

            return `
                <div class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" onclick="closeModal()">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-screen overflow-y-auto" onclick="event.stopPropagation()">
                        
                        <div class="bg-verein-darkblue text-white p-6 rounded-t-2xl flex justify-between items-center">
                            <div>
                                <h2 class="text-xl font-bold">Belege von ${state.modal.mitglied}</h2>
                                <p class="text-cyan-200 text-sm mt-1">${state.modal.belegeDesMitglieds.length} offene Positionen</p>
                            </div>
                            <button onclick="closeModal()" class="text-white hover:text-cyan-200 text-2xl font-bold">‚úï</button>
                        </div>

                        <div class="p-6 space-y-4">
                            ${state.modal.belegeDesMitglieds.map(auslage => {
                                const isChecked = state.modal.ausgewaehlt.includes(auslage.id);
                                return `
                                    <div 
                                        onclick="toggleBeleg(${auslage.id})"
                                        class="border-2 rounded-xl p-4 cursor-pointer transition-all ${isChecked ? 'border-verein-pink bg-verein-pink-light' : 'border-gray-200 hover:border-gray-300'}"
                                    >
                                        <div class="flex items-start gap-4">
                                            <div class="mt-1">
                                                <div class="w-6 h-6 rounded border-2 flex items-center justify-center ${isChecked ? 'bg-verein-pink border-verein-pink' : 'border-gray-400'}">
                                                    ${isChecked ? '<span class="text-white text-xs font-bold">‚úì</span>' : ''}
                                                </div>
                                            </div>
                                            <div class="flex-1">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="font-semibold text-gray-800">${auslage.zweck}</p>
                                                        <p class="text-sm text-gray-500">${auslage.kategorie} ‚Ä¢ ${auslage.datum}</p>
                                                        <span class="inline-block mt-1 px-2 py-0.5 rounded-full text-xs ${auslage.status === 'gepr√ºft' ? 'bg-blue-100 text-blue-700' : 'bg-cyan-100 text-verein-cyan'}">
                                                            ${auslage.status === 'gepr√ºft' ? 'üëÄ Gepr√ºft' : '‚è≥ Offen'}
                                                        </span>
                                                    </div>
                                                    <p class="text-xl font-bold text-verein-pink ml-4">${auslage.betrag.toFixed(2)} ‚Ç¨</p>
                                                </div>
                                                ${auslage.beleg ? `
                                                    <img 
                                                        src="${auslage.beleg}" 
                                                        alt="Beleg" 
                                                        class="w-full max-h-48 object-contain rounded-lg mt-3 border border-gray-200"
                                                        onclick="event.stopPropagation(); viewBeleg('${auslage.beleg}')"
                                                    />
                                                    <p class="text-xs text-gray-400 mt-1 text-center">Klick auf Foto zum Vergr√∂√üern</p>
                                                ` : '<p class="text-xs text-gray-400 mt-2">üìé Kein Beleg hochgeladen</p>'}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <div class="sticky bottom-0 bg-white border-t border-gray-200 p-6 rounded-b-2xl">
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-gray-600 text-sm">${state.modal.ausgewaehlt.length} von ${state.modal.belegeDesMitglieds.length} ausgew√§hlt</p>
                                <p class="text-2xl font-bold text-verein-pink">${summeAusgewaehlt.toFixed(2)} ‚Ç¨</p>
                            </div>
                            <div class="flex gap-3">
                                <button 
                                    onclick="closeModal()"
                                    class="flex-1 py-3 rounded-lg border-2 border-gray-300 text-gray-600 font-semibold hover:bg-gray-50 transition"
                                >
                                    Abbrechen
                                </button>
                                <button 
                                    onclick="bezahleAusgewaehlt()"
                                    class="flex-1 py-3 rounded-lg font-semibold text-white transition ${state.modal.ausgewaehlt.length === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-verein-pink hover:bg-verein-pink-dark'}"
                                    ${state.modal.ausgewaehlt.length === 0 ? 'disabled' : ''}
                                >
                                    üí∞ ${state.modal.ausgewaehlt.length} Belege bezahlen
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        // Render Functions
        function renderLogin() {
            return `
                <div class="min-h-screen bg-gradient-verein flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <div class="text-center mb-8">
                            <img src="${LOGO_BASE64}" alt="Gut und Aussehend" class="w-48 h-48 mx-auto mb-4 object-contain" />
                            <h2 class="text-2xl font-semibold text-gray-800">Auslagen-Verwaltung</h2>
                        </div>
                        
                        <div class="space-y-4">
                            <input
                                type="text"
                                id="loginName"
                                placeholder="Dein Name"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-verein-pink focus-verein:ring-pink focus:outline-none"
                                onkeypress="if(event.key === 'Enter') document.getElementById('loginMitglied').click()"
                            />
                            
                            <button
                                id="loginMitglied"
                                onclick="handleLogin(document.getElementById('loginName').value, 'mitglied')"
                                class="w-full bg-verein-pink text-white py-3 rounded-lg font-semibold hover:bg-verein-pink-dark focus-verein:ring-pink transition-all"
                            >
                                Als Mitglied anmelden
                            </button>
                            
                            <button
                                onclick="handleLogin(document.getElementById('loginName').value, 'kassenwart')"
                                class="w-full bg-verein-cyan text-white py-3 rounded-lg font-semibold hover:bg-verein-cyan-dark focus-verein:ring-cyan transition-all"
                            >
                                Als Kassenwart anmelden
                            </button>
                        </div>

                        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800"><strong>üí° Tipp:</strong> Daten werden lokal im Browser gespeichert</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNavigation() {
            const isMitglied = state.currentUser.rolle === 'mitglied';
            const isKassenwart = state.currentUser.rolle === 'kassenwart';

            return `
                <div class="bg-gradient-verein text-white p-4 shadow-lg">
                    <div class="max-w-6xl mx-auto flex flex-wrap justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <img src="${LOGO_BASE64}" alt="Logo" class="w-12 h-12 object-contain" />
                            <div>
                                <h1 class="text-2xl font-bold">Auslagen-Verwaltung</h1>
                                <p class="text-cyan-200 text-sm">Angemeldet als: ${state.currentUser.name} (${state.currentUser.rolle === 'kassenwart' ? 'Kassenwart' : 'Mitglied'})</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${isMitglied ? `
                                <button
                                    onclick="state.view = 'meine-auslagen'; render();"
                                    class="px-4 py-2 rounded ${state.view === 'meine-auslagen' ? 'bg-white text-verein-pink' : 'bg-verein-pink hover:bg-verein-pink-dark'}"
                                >
                                    Meine Auslagen
                                </button>
                                <button
                                    onclick="state.view = 'neue-auslage'; render();"
                                    class="px-4 py-2 rounded ${state.view === 'neue-auslage' ? 'bg-white text-verein-pink' : 'bg-verein-pink hover:bg-verein-pink-dark'}"
                                >
                                    + Neue Auslage
                                </button>
                            ` : ''}
                            ${isKassenwart ? `
                                <button
                                    onclick="state.view = 'dashboard'; render();"
                                    class="px-4 py-2 rounded ${state.view === 'dashboard' ? 'bg-white text-verein-pink' : 'bg-verein-pink hover:bg-verein-pink-dark'}"
                                >
                                    Dashboard
                                </button>
                                <button
                                    onclick="exportCSV()"
                                    class="px-4 py-2 rounded bg-green-500 hover:bg-green-600"
                                >
                                    üìä CSV Export
                                </button>
                            ` : ''}
                            <button
                                onclick="handleLogout()"
                                class="px-4 py-2 rounded bg-red-500 hover:bg-red-600"
                            >
                                Abmelden
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNeueAuslage() {
            return `
                <div class="min-h-screen bg-gray-50">
                    ${renderNavigation()}
                    <div class="max-w-2xl mx-auto p-6">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Neue Auslage erfassen</h2>
                            
                            <form onsubmit="handleSubmit(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Betrag (‚Ç¨) *
                                    </label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        required
                                        value="${state.formData.betrag}"
                                        oninput="state.formData.betrag = this.value"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus-verein:ring-pink focus:outline-none"
                                        placeholder="z.B. 12.50"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Datum *
                                    </label>
                                    <input
                                        type="date"
                                        required
                                        value="${state.formData.datum}"
                                        oninput="state.formData.datum = this.value"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus-verein:ring-pink focus:outline-none"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Kategorie
                                    </label>
                                    <select
                                        value="${state.formData.kategorie}"
                                        onchange="state.formData.kategorie = this.value"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus-verein:ring-pink focus:outline-none"
                                    >
                                        <option ${state.formData.kategorie === 'Kost√ºme' ? 'selected' : ''}>Kost√ºme</option>
                                        <option ${state.formData.kategorie === 'Dekoration' ? 'selected' : ''}>Dekoration</option>
                                        <option ${state.formData.kategorie === 'Verpflegung' ? 'selected' : ''}>Verpflegung</option>
                                        <option ${state.formData.kategorie === 'Transport' ? 'selected' : ''}>Transport</option>
                                        <option ${state.formData.kategorie === 'Musik/Technik' ? 'selected' : ''}>Musik/Technik</option>
                                        <option ${state.formData.kategorie === 'Sonstiges' ? 'selected' : ''}>Sonstiges</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Zweck / Beschreibung *
                                    </label>
                                    <textarea
                                        required
                                        value="${state.formData.zweck}"
                                        oninput="state.formData.zweck = this.value"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus-verein:ring-pink focus:outline-none"
                                        rows="3"
                                        placeholder="z.B. Stoffe f√ºr Kost√ºme, Getr√§nke f√ºr Festwagen..."
                                    >${state.formData.zweck}</textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Beleg hochladen *
                                    </label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                        ${state.formData.beleg ? `
                                            <div>
                                                <img src="${state.formData.beleg}" alt="Beleg" class="max-w-full h-48 mx-auto mb-2 rounded" />
                                                <button
                                                    type="button"
                                                    onclick="removeBeleg()"
                                                    class="text-red-500 text-sm hover:text-red-700"
                                                >
                                                    üóëÔ∏è Entfernen
                                                </button>
                                            </div>
                                        ` : `
                                            <div class="text-gray-500 mb-2">üì∏</div>
                                            <input
                                                type="file"
                                                accept="image/*"
                                                onchange="handleBelegUpload(event)"
                                                class="hidden"
                                                id="beleg-upload"
                                                required
                                            />
                                            <label
                                                for="beleg-upload"
                                                class="cursor-pointer text-verein-pink hover:bg-verein-pink-light px-3 py-1 rounded font-medium transition"
                                            >
                                                Foto ausw√§hlen oder hier klicken
                                            </label>
                                            <p class="text-xs text-gray-500 mt-2">JPG, PNG, max 10MB</p>
                                        `}
                                    </div>
                                </div>

                                <button
                                    type="submit"
                                    class="w-full bg-verein-pink text-white py-3 rounded-lg font-semibold hover:bg-verein-pink-dark focus-verein:ring-pink transition-all"
                                >
                                    Auslage einreichen
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMeineAuslagen() {
            const meineAuslagen = state.auslagen.filter(a => a.mitglied === state.currentUser.name);
            const summeOffen = meineAuslagen.filter(a => a.status === 'offen').reduce((sum, a) => sum + a.betrag, 0);
            const summeBezahlt = meineAuslagen.filter(a => a.status === 'bezahlt').reduce((sum, a) => sum + a.betrag, 0);

            return `
                <div class="min-h-screen bg-gray-50">
                    ${renderNavigation()}
                    <div class="max-w-6xl mx-auto p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Offen</p>
                                        <p class="text-3xl font-bold text-verein-cyan">${summeOffen.toFixed(2)} ‚Ç¨</p>
                                    </div>
                                    <div class="text-4xl">‚è≥</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Bezahlt</p>
                                        <p class="text-3xl font-bold text-green-500">${summeBezahlt.toFixed(2)} ‚Ç¨</p>
                                    </div>
                                    <div class="text-4xl">‚úÖ</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Gesamt</p>
                                        <p class="text-3xl font-bold text-verein-pink">${meineAuslagen.length}</p>
                                    </div>
                                    <div class="text-4xl">üìÑ</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow">
                            <div class="p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Meine Auslagen</h2>
                                
                                ${meineAuslagen.length === 0 ? `
                                    <p class="text-gray-500 text-center py-8">Noch keine Auslagen erfasst</p>
                                ` : `
                                    <div class="space-y-4">
                                        ${meineAuslagen.sort((a, b) => b.id - a.id).map(auslage => `
                                            <div class="border rounded-lg p-4 hover:shadow-md transition">
                                                <div class="flex flex-wrap justify-between items-start mb-2 gap-4">
                                                    <div class="flex-1 min-w-0">
                                                        <h3 class="font-semibold text-lg">${auslage.zweck}</h3>
                                                        <p class="text-sm text-gray-500">${auslage.kategorie} ‚Ä¢ ${auslage.datum}</p>
                                                    </div>
                                                    <div class="text-right">
                                                        <p class="text-2xl font-bold text-verein-pink">${auslage.betrag.toFixed(2)} ‚Ç¨</p>
                                                        <span class="inline-block px-3 py-1 rounded-full text-sm font-medium ${
                                                            auslage.status === 'offen' ? 'bg-verein-cyan-light text-verein-cyan' :
                                                            auslage.status === 'gepr√ºft' ? 'bg-verein-pink-light text-verein-pink' :
                                                            'bg-green-100 text-green-700'
                                                        }">
                                                            ${auslage.status === 'offen' ? '‚è≥ Offen' :
                                                              auslage.status === 'gepr√ºft' ? 'üëÄ Gepr√ºft' :
                                                              '‚úÖ Bezahlt'}
                                                        </span>
                                                    </div>
                                                </div>
                                                ${auslage.beleg ? `
                                                    <img 
                                                        src="${auslage.beleg}" 
                                                        alt="Beleg" 
                                                        class="w-32 h-32 object-cover rounded mt-2 cursor-pointer hover:opacity-80" 
                                                        onclick="viewBeleg('${auslage.beleg}')"
                                                    />
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const offeneAuslagen = state.auslagen.filter(a => a.status === 'offen');
            const gepruefteAuslagen = state.auslagen.filter(a => a.status === 'gepr√ºft');
            const bezahlteAuslagen = state.auslagen.filter(a => a.status === 'bezahlt');
            
            const summeOffen = offeneAuslagen.reduce((sum, a) => sum + a.betrag, 0);
            const summeGeprueft = gepruefteAuslagen.reduce((sum, a) => sum + a.betrag, 0);
            const summeBezahlt = bezahlteAuslagen.reduce((sum, a) => sum + a.betrag, 0);
            const KASSENBESTAND = 5000.00;
            const kassenbestandAktuell = KASSENBESTAND - summeBezahlt;
            const kassenbestandNachAbzug = kassenbestandAktuell - summeOffen - summeGeprueft;

            return `
                <div class="min-h-screen bg-gray-50">
                    ${renderNavigation()}
                    <div class="max-w-6xl mx-auto p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Offen</p>
                                        <p class="text-2xl font-bold text-verein-cyan">${summeOffen.toFixed(2)} ‚Ç¨</p>
                                        <p class="text-gray-400 text-xs">${offeneAuslagen.length} Positionen</p>
                                    </div>
                                    <div class="text-3xl">‚ö†Ô∏è</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Gepr√ºft</p>
                                        <p class="text-2xl font-bold text-blue-500">${summeGeprueft.toFixed(2)} ‚Ç¨</p>
                                        <p class="text-gray-400 text-xs">${gepruefteAuslagen.length} Positionen</p>
                                    </div>
                                    <div class="text-3xl">üëÄ</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Bezahlt</p>
                                        <p class="text-2xl font-bold text-green-500">${summeBezahlt.toFixed(2)} ‚Ç¨</p>
                                        <p class="text-gray-400 text-xs">${bezahlteAuslagen.length} Positionen</p>
                                    </div>
                                    <div class="text-3xl">‚úÖ</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Gesamt</p>
                                        <p class="text-2xl font-bold text-verein-pink">${state.auslagen.length}</p>
                                        <p class="text-gray-400 text-xs">Alle Auslagen</p>
                                    </div>
                                    <div class="text-3xl">üìä</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-verein-darkblue rounded-lg shadow p-6 relative">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <p class="text-cyan-200 text-sm">Kassenbestand aktuell</p>
                                            <span class="text-cyan-400 text-xs cursor-help relative group">‚ÑπÔ∏è
                                                <div class="absolute top-6 left-0 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 hidden group-hover:block z-10 whitespace-nowrap shadow-lg">
                                                    Anfangsbestand: ${KASSENBESTAND.toFixed(2)} ‚Ç¨
                                                </div>
                                            </span>
                                        </div>
                                        <p class="text-3xl font-bold text-white">${kassenbestandAktuell.toFixed(2)} ‚Ç¨</p>
                                        <p class="text-cyan-300 text-xs mt-1">bereits bezahlt: ${summeBezahlt.toFixed(2)} ‚Ç¨</p>
                                    </div>
                                    <div class="text-3xl">üè¶</div>
                                </div>
                            </div>
                            <div class="rounded-lg shadow p-6 ${kassenbestandNachAbzug < 0 ? 'bg-red-600' : 'bg-verein-pink'}">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-pink-100 text-sm">Kasse nach offenen Abz√ºgen</p>
                                        <p class="text-3xl font-bold text-white">${kassenbestandNachAbzug.toFixed(2)} ‚Ç¨</p>
                                        <p class="text-pink-200 text-xs mt-1">Abzug: ${(summeOffen + summeGeprueft).toFixed(2)} ‚Ç¨</p>
                                    </div>
                                    <div class="text-3xl">${kassenbestandNachAbzug < 0 ? '‚ö†Ô∏è' : '‚úÖ'}</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                            <div class="p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">üí∏ Auszahlungen je Mitglied</h2>
                                ${(() => {
                                    const zuBezahlen = state.auslagen.filter(a => a.status === 'offen' || a.status === 'gepr√ºft');
                                    const nachMitglied = zuBezahlen.reduce((acc, a) => {
                                        if (!acc[a.mitglied]) acc[a.mitglied] = { offen: 0, geprueft: 0 };
                                        if (a.status === 'offen') acc[a.mitglied].offen += a.betrag;
                                        if (a.status === 'gepr√ºft') acc[a.mitglied].geprueft += a.betrag;
                                        return acc;
                                    }, {});
                                    
                                    if (Object.keys(nachMitglied).length === 0) {
                                        return '<p class="text-gray-500 text-center py-4">Keine offenen Auszahlungen</p>';
                                    }
                                    
                                    return '<div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr>' +
                                        '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Mitglied</th>' +
                                        '<th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Offen</th>' +
                                        '<th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Gepr√ºft</th>' +
                                        '<th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Gesamt auszuzahlen</th>' +
                                        '</tr></thead><tbody class="divide-y divide-gray-200">' +
                                        Object.entries(nachMitglied)
                                            .sort((a, b) => (b[1].offen + b[1].geprueft) - (a[1].offen + a[1].geprueft))
                                            .map(([name, betraege]) => {
                                                const gesamt = betraege.offen + betraege.geprueft;
                                                return `<tr class="hover:bg-gray-50 cursor-pointer" onclick="openBelegModal('${name}')">
                                                    <td class="px-4 py-3 text-sm font-medium">${name}</td>
                                                    <td class="px-4 py-3 text-sm text-right text-verein-cyan">${betraege.offen.toFixed(2)} ‚Ç¨</td>
                                                    <td class="px-4 py-3 text-sm text-right text-blue-500">${betraege.geprueft.toFixed(2)} ‚Ç¨</td>
                                                    <td class="px-4 py-3 text-sm text-right font-bold text-verein-pink">${gesamt.toFixed(2)} ‚Ç¨</td>
                                                </tr>`;
                                            }).join('') +
                                        '</tbody></table></div>';
                                })()}
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Alle Auslagen</h2>
                                
                                ${state.auslagen.length === 0 ? `
                                    <p class="text-gray-500 text-center py-8">Noch keine Auslagen vorhanden</p>
                                ` : `
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Datum</th>
                                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Mitglied</th>
                                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Zweck</th>
                                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kategorie</th>
                                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Betrag</th>
                                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Beleg</th>
                                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Status</th>
                                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Aktionen</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-200">
                                                ${state.auslagen.sort((a, b) => b.id - a.id).map(auslage => `
                                                    <tr class="hover:bg-gray-50">
                                                        <td class="px-4 py-3 text-sm">${auslage.datum}</td>
                                                        <td class="px-4 py-3 text-sm font-medium">${auslage.mitglied}</td>
                                                        <td class="px-4 py-3 text-sm">${auslage.zweck}</td>
                                                        <td class="px-4 py-3 text-sm text-gray-500">${auslage.kategorie}</td>
                                                        <td class="px-4 py-3 text-sm text-right font-semibold">${auslage.betrag.toFixed(2)} ‚Ç¨</td>
                                                        <td class="px-4 py-3 text-center">
                                                            ${auslage.beleg ? `
                                                                <button
                                                                    onclick="viewBeleg('${auslage.beleg}')"
                                                                    class="text-verein-pink hover:text-verein-pink-dark text-sm"
                                                                >
                                                                    üìÑ Ansehen
                                                                </button>
                                                            ` : '-'}
                                                        </td>
                                                        <td class="px-4 py-3 text-center">
                                                            <span class="inline-block px-3 py-1 rounded-full text-xs font-medium ${
                                                                auslage.status === 'offen' ? 'bg-verein-cyan-light text-verein-cyan' :
                                                                auslage.status === 'gepr√ºft' ? 'bg-verein-pink-light text-verein-pink' :
                                                                'bg-green-100 text-green-700'
                                                            }">
                                                                ${auslage.status}
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-3 text-center">
                                                            <div class="flex gap-1 justify-center flex-wrap">
                                                                ${auslage.status === 'offen' ? `
                                                                    <button
                                                                        onclick="updateStatus(${auslage.id}, 'gepr√ºft')"
                                                                        class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
                                                                        title="Als gepr√ºft markieren"
                                                                    >
                                                                        ‚úì Pr√ºfen
                                                                    </button>
                                                                ` : ''}
                                                                ${(auslage.status === 'offen' || auslage.status === 'gepr√ºft') ? `
                                                                    <button
                                                                        onclick="updateStatus(${auslage.id}, 'bezahlt')"
                                                                        class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600"
                                                                        title="Als bezahlt markieren"
                                                                    >
                                                                        üí∞ Bezahlen
                                                                    </button>
                                                                ` : ''}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Main Render Function
        function render() {
            const app = document.getElementById('app');
            if (!state.currentUser) {
                app.innerHTML = renderLogin() + renderToast();
            } else if (state.view === 'neue-auslage') {
                app.innerHTML = renderNeueAuslage() + renderToast();
            } else if (state.view === 'meine-auslagen') {
                app.innerHTML = renderMeineAuslagen() + renderToast();
            } else if (state.view === 'dashboard') {
                app.innerHTML = renderDashboard() + renderModal() + renderToast();
            }
        }
        // Initialize App
        loadData();
        render();
    </script>
</body>
</html>
