<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auslagen-Verwaltung - Gut und Aussehend</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        /* Logo-optimierte Vereinsfarben - perfekt abgestimmt */
        .bg-verein-darkblue { background-color: #0A1929; }
        .bg-verein-pink { background-color: #E91E7E; }
        .bg-verein-cyan { background-color: #4FD9D9; }
        
        .text-verein-darkblue { color: #0A192F; }
        .text-verein-pink { color: #E91E7E; }
        .text-verein-cyan { color: #4FD9D9; }
        
        /* Dunklere Hover-Varianten */
        .hover\:bg-verein-pink-dark:hover { background-color: #C2185B; }
        .hover\:bg-verein-cyan-dark:hover { background-color: #26C6DA; }
        .hover\:bg-verein-darkblue-dark:hover { background-color: #061A2B; }
        
        /* Border-Varianten */
        .border-verein-pink { border-color: #E91E7E; }
        .border-verein-cyan { border-color: #4FD9D9; }
        .border-verein-darkblue { border-color: #0A1929; }
        
        /* Helle Varianten f√ºr bessere Lesbarkeit */
        .bg-verein-pink-light { background-color: #FCE4EC; }
        .bg-verein-cyan-light { background-color: #E0F7FA; }
        
        /* Perfekter Logo-Gradient */
        .bg-gradient-verein {
            background: linear-gradient(135deg, #0A1929 0%, #E91E7E 40%, #4FD9D9 100%);
        }
        
        /* Focus-Rings f√ºr Barrierefreiheit */
        .focus-verein\:ring-pink:focus { 
            --tw-ring-color: #E91E7E;
            --tw-ring-offset-width: 2px;
        }
        .focus-verein\:ring-cyan:focus { 
            --tw-ring-color: #4FD9D9;
            --tw-ring-offset-width: 2px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // Vereins-Logo als Base64
        const LOGO_BASE64 = 'logo.png';

        // App State
        let state = {
            currentUser: null,
            view: 'login',
            auslagen: [],
            toast: null,
            belegOverlay: null,
            filter: {
                mitglied: '',
                status: '',
                kategorie: ''
            },
            editModal: {
                open: false,
                auslage: null,
                formData: {}
            },
            kategorien: [
                'Kost√ºme',
                'Gestaltung',
                'Allgemeines',
                'Bauen',
                'Altstadttanz',
                'Weihnachtsfeier',
                'Verpflegung bauen',
                'Wurfmaterial/Getr√§nke',
                'Technik'
            ],
            kategorienModal: {
                open: false,
                neueKategorie: ''
            },
            reportModal: {
                open: false,
                typ: 'kategorie',
                vonDatum: new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0],
                bisDatum: new Date().toISOString().split('T')[0],
                data: null,
                expandedRow: null
            },
            modal: {
                    open: false,
                    mitglied: null,
                    ausgewaehlt: []
                    },            
            formData: {
                betrag: '',
                datum: new Date().toISOString().split('T')[0],
                zweck: '',
                kategorie: 'Kost√ºme',
                beleg: null
            }
        };

        // LocalStorage Functions
        function loadData() {
            const stored = localStorage.getItem('auslagen-data');
            if (stored) {
                state.auslagen = JSON.parse(stored);
            }
            const kategorien = localStorage.getItem('kategorien');
            if (kategorien) {
                state.kategorien = JSON.parse(kategorien);
            }
        }

       function saveData() {
            localStorage.setItem('auslagen-data', JSON.stringify(state.auslagen));
            localStorage.setItem('kategorien', JSON.stringify(state.kategorien));
        }

        let debounceTimer;
        function debounceRender(delay = 300) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => render(), delay);
        }

        // Kategorien-Verwaltung
        function openKategorienModal() {
            state.kategorienModal = { open: true, neueKategorie: '' };
            render();
        }

        function closeKategorienModal() {
            state.kategorienModal = { open: false, neueKategorie: '' };
            render();
        }

        function addKategorie() {
            const name = state.kategorienModal.neueKategorie.trim();
            if (!name) {
                state.toast = 'Bitte einen Namen eingeben!';
                render();
                return;
            }
            if (state.kategorien.includes(name)) {
                state.toast = 'Diese Kategorie existiert bereits!';
                render();
                return;
            }
            state.kategorien.push(name);
            state.kategorien.sort();
            saveData();
            state.kategorienModal.neueKategorie = '';
            state.toast = 'Kategorie erfolgreich hinzugef√ºgt!';
            render();
        }

        function deleteKategorie(name) {
            const inUse = state.auslagen.some(a => a.kategorie === name);
            if (inUse) {
                state.toast = 'Kategorie wird noch von Auslagen verwendet und kann nicht gel√∂scht werden!';
                render();
                return;
            }
            state.kategorien = state.kategorien.filter(k => k !== name);
            saveData();
            state.toast = 'Kategorie erfolgreich gel√∂scht!';
            render();
        }

 // Report-Funktionen
        function openReportModal() {
            state.reportModal.open = true;
            generateReport();
        }

        function closeReportModal() {
            state.reportModal = {
                open: false,
                typ: 'kategorie',
                vonDatum: new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0],
                bisDatum: new Date().toISOString().split('T')[0],
                data: null
            };
            render();
        }

        function generateReport() {
            const von = new Date(state.reportModal.vonDatum);
            const bis = new Date(state.reportModal.bisDatum);
            bis.setHours(23, 59, 59);
            
            // Alle Auslagen im Zeitraum, unabh√§ngig vom Status
            const filtered = state.auslagen.filter(a => {
                const datum = new Date(a.datum);
                return datum >= von && datum <= bis;
            });

            let data = [];
            
            if (state.reportModal.typ === 'kategorie') {
                const grouped = filtered.reduce((acc, a) => {
                    if (!acc[a.kategorie]) acc[a.kategorie] = { summe: 0, anzahl: 0, auslagen: [] };
                    acc[a.kategorie].summe += a.betrag;
                    acc[a.kategorie].anzahl++;
                    acc[a.kategorie].auslagen.push(a);
                    return acc;
                }, {});
                
                data = Object.entries(grouped)
                    .map(([kat, werte]) => ({
                        key: kat,
                        kategorie: kat,
                        anzahl: werte.anzahl,
                        summe: werte.summe,
                        auslagen: werte.auslagen.sort((a, b) => new Date(b.datum) - new Date(a.datum))
                    }))
                    .sort((a, b) => b.summe - a.summe);
                    
            } else if (state.reportModal.typ === 'mitglied') {
                const grouped = filtered.reduce((acc, a) => {
                    if (!acc[a.mitglied]) acc[a.mitglied] = { summe: 0, anzahl: 0, auslagen: [] };
                    acc[a.mitglied].summe += a.betrag;
                    acc[a.mitglied].anzahl++;
                    acc[a.mitglied].auslagen.push(a);
                    return acc;
                }, {});
                
                data = Object.entries(grouped)
                    .map(([name, werte]) => ({
                        key: name,
                        mitglied: name,
                        anzahl: werte.anzahl,
                        summe: werte.summe,
                        auslagen: werte.auslagen.sort((a, b) => new Date(b.datum) - new Date(a.datum))
                    }))
                    .sort((a, b) => b.summe - a.summe);
                    
            } else if (state.reportModal.typ === 'monat') {
                const grouped = filtered.reduce((acc, a) => {
                    const monat = new Date(a.datum).toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit' });
                    if (!acc[monat]) acc[monat] = { summe: 0, anzahl: 0, auslagen: [] };
                    acc[monat].summe += a.betrag;
                    acc[monat].anzahl++;
                    acc[monat].auslagen.push(a);
                    return acc;
                }, {});
                
                data = Object.entries(grouped)
                    .map(([monat, werte]) => ({
                        key: monat,
                        monat: monat,
                        anzahl: werte.anzahl,
                        summe: werte.summe,
                        auslagen: werte.auslagen.sort((a, b) => new Date(b.datum) - new Date(a.datum))
                    }))
                    .sort((a, b) => a.monat.localeCompare(b.monat));
                    
            } else if (state.reportModal.typ === 'status') {
                const grouped = filtered.reduce((acc, a) => {
                    if (!acc[a.status]) acc[a.status] = { summe: 0, anzahl: 0, auslagen: [] };
                    acc[a.status].summe += a.betrag;
                    acc[a.status].anzahl++;
                    acc[a.status].auslagen.push(a);
                    return acc;
                }, {});
                
                data = Object.entries(grouped).map(([status, werte]) => ({
                    key: status,
                    status: status,
                    anzahl: werte.anzahl,
                    summe: werte.summe,
                    auslagen: werte.auslagen.sort((a, b) => new Date(b.datum) - new Date(a.datum))
                }));
            }
            
            state.reportModal.data = data;
            render();
        }

        function toggleReportRow(key) {
            if (state.reportModal.expandedRow === key) {
                state.reportModal.expandedRow = null;
            } else {
                state.reportModal.expandedRow = key;
            }
            render();
        }



        function exportReport() {
            if (!state.reportModal.data || state.reportModal.data.length === 0) {
                state.toast = 'Keine Daten zum Exportieren vorhanden!';
                render();
                return;
            }
            
            let csv = '';
            const typ = state.reportModal.typ;
            
            if (typ === 'kategorie') {
                csv = [
                    ['Kategorie', 'Anzahl Belege', 'Summe (EUR)'].join(';'),
                    ...state.reportModal.data.map(d => [d.kategorie, d.anzahl, d.summe.toFixed(2)].join(';'))
                ].join('\n');
            } else if (typ === 'mitglied') {
                csv = [
                    ['Mitglied', 'Anzahl Belege', 'Summe (EUR)'].join(';'),
                    ...state.reportModal.data.map(d => [d.mitglied, d.anzahl, d.summe.toFixed(2)].join(';'))
                ].join('\n');
            } else if (typ === 'monat') {
                csv = [
                    ['Monat', 'Anzahl Belege', 'Summe (EUR)'].join(';'),
                    ...state.reportModal.data.map(d => [d.monat, d.anzahl, d.summe.toFixed(2)].join(';'))
                ].join('\n');
            } else if (typ === 'status') {
                csv = [
                    ['Status', 'Anzahl Belege', 'Summe (EUR)'].join(';'),
                    ...state.reportModal.data.map(d => [d.status, d.anzahl, d.summe.toFixed(2)].join(';'))
                ].join('\n');
            }
            
            csv += '\n\n';
            csv += `Zeitraum;${state.reportModal.vonDatum};bis;${state.reportModal.bisDatum}\n`;
            csv += `Erstellt am;${new Date().toLocaleDateString('de-DE')};${new Date().toLocaleTimeString('de-DE')}`;
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const typeName = {
                'kategorie': 'Kategorien',
                'mitglied': 'Mitglieder',
                'monat': 'Monate',
                'status': 'Status'
            }[typ];
            link.download = `Report_${typeName}_${state.reportModal.vonDatum}_bis_${state.reportModal.bisDatum}.csv`;
            link.click();
            
            state.toast = 'Report erfolgreich exportiert!';
            render();
        }

        // Login
        function handleLogin(name, rolle) {
            if (!name.trim()) {
                alert('Bitte Namen eingeben!');
                return;
            }
            state.currentUser = { name, rolle };
            state.view = rolle === 'kassenwart' ? 'dashboard' : 'meine-auslagen';
            render();
        }

        // Logout
        function handleLogout() {
            state.currentUser = null;
            state.view = 'login';
            render();
        }

        // Beleg Upload mit Kompression
        function handleBelegUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    compressImage(reader.result, (compressed) => {
                        state.formData.beleg = compressed;
                        render();
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        // Bildkompression
        function compressImage(base64, callback) {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Max 800px Breite
                const maxWidth = 800;
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Qualit√§t 0.7 = guter Kompromiss
                callback(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.src = base64;
        }

        // Remove Beleg
        function removeBeleg() {
            state.formData.beleg = null;
            render();
        }

        // Submit Auslage
        function handleSubmit(event) {
            event.preventDefault();
            
        const neueAuslage = {
                id: Date.now(),
                mitglied: state.currentUser.name,
                betrag: parseFloat(state.formData.betrag),
                datum: state.formData.datum,
                zweck: state.formData.zweck,
                kategorie: state.formData.kategorie,
                beleg: state.formData.beleg,
                status: 'offen',
                eingereichtAm: new Date().toISOString(),
                bezahltAm: null,
                historie: [{
                    zeitpunkt: new Date().toISOString(),
                    aktion: 'Erstellt',
                    benutzer: state.currentUser.name
                }]
            };

            state.auslagen.push(neueAuslage);
            saveData();
            
            // Reset Form
            state.formData = {
                betrag: '',
                datum: new Date().toISOString().split('T')[0],
                zweck: '',
                kategorie: 'Kost√ºme',
                beleg: null
            };
            
            state.view = 'meine-auslagen';
            state.toast = 'Auslage erfolgreich eingereicht!';
            render();
        }

        // Update Status
        function updateStatus(id, newStatus) {
            const auslage = state.auslagen.find(a => a.id === id);
            if (auslage) {
                auslage.status = newStatus;
                if (newStatus === 'bezahlt') {
                    auslage.bezahltAm = new Date().toISOString();
                }
                saveData();
                render();
            }
        }

        // View Beleg
        function viewBeleg(id) {
            const auslage = state.auslagen.find(a => a.id === id);
            if (auslage && auslage.beleg) {
                state.belegOverlay = auslage;
                render();
            }
        }

        function closeBelegOverlay() {
            state.belegOverlay = null;
            render();
        }

        // Export CSV
        function exportCSV() {
            const csv = [
                ['Datum', 'Mitglied', 'Kategorie', 'Zweck', 'Betrag', 'Status', 'Eingereicht am', 'Bezahlt am'].join(';'),
                ...state.auslagen.map(a => [
                    a.datum,
                    a.mitglied,
                    a.kategorie,
                    a.zweck,
                    a.betrag.toFixed(2),
                    a.status,
                    new Date(a.eingereichtAm).toLocaleDateString('de-DE'),
                    a.bezahltAm ? new Date(a.bezahltAm).toLocaleDateString('de-DE') : ''
                ].join(';'))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'auslagen_export_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        function openBelegModal(mitglied) {
            const belegeDesMitglieds = state.auslagen.filter(
                a => a.mitglied === mitglied && a.status === 'offen'
            );
            state.modal = {
                open: true,
                mitglied: mitglied,
                belegeDesMitglieds: belegeDesMitglieds,
                ausgewaehlt: []
            };
            render();
        }

        function toggleBeleg(id) {
            const idx = state.modal.ausgewaehlt.indexOf(id);
            if (idx === -1) {
                state.modal.ausgewaehlt.push(id);
            } else {
                state.modal.ausgewaehlt.splice(idx, 1);
            }
            render();
        }

        function bezahleAusgewaehlt() {
            if (state.modal.ausgewaehlt.length === 0) {
                alert('Bitte mindestens einen Beleg ausw√§hlen!');
                return;
            }
            state.modal.ausgewaehlt.forEach(id => updateStatus(id, 'bezahlt'));
            state.modal = { open: false, mitglied: null, belegeDesMitglieds: [], ausgewaehlt: [] };
            render();
        }

        function closeModal() {
            state.modal = { open: false, mitglied: null, belegeDesMitglieds: [], ausgewaehlt: [] };
            render();
        }

        function deleteAuslage(id) {
            const auslage = state.auslagen.find(a => a.id === id);
            if (!auslage) return;
            if (state.currentUser.rolle === 'mitglied' && auslage.status !== 'offen') {
                state.toast = 'Nur offene Auslagen k√∂nnen gel√∂scht werden!';
                render();
                return;
            }
            state.auslagen = state.auslagen.filter(a => a.id !== id);
            saveData();
            state.toast = 'Auslage erfolgreich gel√∂scht!';
            render();
        }
       
        function openEditModal(id) {
            const auslage = state.auslagen.find(a => a.id === id);
            if (!auslage) return;
            
            // Berechtigungspr√ºfung
            if (state.currentUser.rolle === 'mitglied') {
                if (auslage.mitglied !== state.currentUser.name || auslage.status !== 'offen') {
                    state.toast = 'Nur eigene offene Auslagen k√∂nnen bearbeitet werden!';
                    render();
                    return;
                }
            }
            
            state.editModal = {
                open: true,
                auslage: auslage,
                formData: {
                    betrag: auslage.betrag,
                    datum: auslage.datum,
                    zweck: auslage.zweck,
                    kategorie: auslage.kategorie
                }
            };
            render();
        }

        function closeEditModal() {
            state.editModal = { open: false, auslage: null, formData: {} };
            render();
        }

        function saveEdit() {
            const auslage = state.auslagen.find(a => a.id === state.editModal.auslage.id);
            if (!auslage) return;
            
            const aenderungen = [];
            if (parseFloat(state.editModal.formData.betrag) !== auslage.betrag) {
                aenderungen.push({
                    feld: 'Betrag',
                    alt: auslage.betrag.toFixed(2) + ' ‚Ç¨',
                    neu: parseFloat(state.editModal.formData.betrag).toFixed(2) + ' ‚Ç¨'
                });
                auslage.betrag = parseFloat(state.editModal.formData.betrag);
            }
            if (state.editModal.formData.datum !== auslage.datum) {
                aenderungen.push({
                    feld: 'Datum',
                    alt: auslage.datum,
                    neu: state.editModal.formData.datum
                });
                auslage.datum = state.editModal.formData.datum;
            }
            if (state.editModal.formData.zweck !== auslage.zweck) {
                aenderungen.push({
                    feld: 'Zweck',
                    alt: auslage.zweck,
                    neu: state.editModal.formData.zweck
                });
                auslage.zweck = state.editModal.formData.zweck;
            }
            if (state.editModal.formData.kategorie !== auslage.kategorie) {
                aenderungen.push({
                    feld: 'Kategorie',
                    alt: auslage.kategorie,
                    neu: state.editModal.formData.kategorie
                });
                auslage.kategorie = state.editModal.formData.kategorie;
            }
            
            if (aenderungen.length > 0) {
                if (!auslage.historie) auslage.historie = [];
                auslage.historie.push({
                    zeitpunkt: new Date().toISOString(),
                    aktion: 'Bearbeitet',
                    benutzer: state.currentUser.name,
                    aenderungen: aenderungen
                });
                saveData();
                state.toast = '√Ñnderungen erfolgreich gespeichert!';
            } else {
                state.toast = 'Keine √Ñnderungen vorgenommen.';
            }
            
            closeEditModal();
        }

        function renderBelegOverlay() {
            if (!state.belegOverlay) return '';
            const a = state.belegOverlay;
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50" onclick="closeBelegOverlay()"></div>
                <div class="fixed top-0 right-0 h-full w-full max-w-lg bg-white z-50 shadow-2xl flex flex-col">
                    
                    <div class="bg-verein-darkblue text-white p-5 flex justify-between items-center flex-shrink-0">
                        <div>
                            <p class="text-xs text-cyan-300 mb-1">Beleg von</p>
                            <h2 class="text-lg font-bold">${a.mitglied}</h2>
                        </div>
                        <button 
                            onclick="closeBelegOverlay()"
                            class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-full w-10 h-10 flex items-center justify-center text-xl font-bold transition"
                        >
                            ‚úï
                        </button>
                    </div>

                    <div class="p-5 border-b border-gray-100 flex-shrink-0">
                        <h3 class="font-semibold text-gray-800 text-lg mb-1">${a.zweck}</h3>
                        <div class="flex flex-wrap gap-3 mt-2">
                            <span class="text-2xl font-bold text-verein-pink">${a.betrag.toFixed(2)} ‚Ç¨</span>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
                                a.status === 'offen' ? 'bg-verein-cyan-light text-verein-cyan' :
                                'bg-green-100 text-green-700'
                            }">
                                ${a.status === 'offen' ? '‚è≥ Offen' : '‚úÖ Bezahlt'}
                            </span>
                        </div>
                        <div class="flex gap-4 mt-3 text-sm text-gray-500">
                            <span>üìÖ ${a.datum}</span>
                            <span>üè∑Ô∏è ${a.kategorie}</span>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto p-5">
                        <p class="text-xs text-gray-400 uppercase font-semibold mb-3">Beleg-Foto</p>
                        <img 
                            src="${a.beleg}" 
                            alt="Beleg" 
                            class="w-full object-contain rounded-xl border border-gray-200"
                        />
                    </div>

                    <div class="p-5 border-t border-gray-100 flex-shrink-0">
                        <div class="flex gap-3">
                            ${a.status === 'offen' ? `
                                <button 
                                    onclick="updateStatus(${a.id}, 'bezahlt'); closeBelegOverlay();"
                                    class="flex-1 py-3 rounded-lg bg-green-500 hover:bg-green-600 text-white font-semibold transition"
                                >
                                    üí∞ Bezahlen
                                </button>
                            ` : ''}
                            <button 
                                onclick="openEditModal(${a.id}); closeBelegOverlay();"
                                class="flex-1 py-3 rounded-lg bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-semibold transition"
                            >
                                ‚úèÔ∏è Bearbeiten
                            </button>
                            <button 
                                onclick="closeBelegOverlay()"
                                class="flex-1 py-3 rounded-lg border-2 border-gray-300 text-gray-600 font-semibold hover:bg-gray-50 transition"
                            >
                                Schlie√üen
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEditModal() {
            if (!state.editModal.open) return '';
            const a = state.editModal.auslage;
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" onclick="closeEditModal()">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-screen overflow-y-auto" onclick="event.stopPropagation()">
                        
                        <div class="bg-verein-darkblue text-white p-6 rounded-t-2xl flex justify-between items-center">
                            <div>
                                <h2 class="text-xl font-bold">Auslage bearbeiten</h2>
                                <p class="text-cyan-200 text-sm mt-1">${a.mitglied} ‚Ä¢ ${a.status}</p>
                            </div>
                            <button onclick="closeEditModal()" class="text-white hover:text-cyan-200 text-2xl font-bold">‚úï</button>
                        </div>

                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Betrag (‚Ç¨) *</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    required
                                    value="${state.editModal.formData.betrag}"
                                    oninput="state.editModal.formData.betrag = this.value"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus:outline-none"
                                />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Datum *</label>
                                <input
                                    type="date"
                                    required
                                    value="${state.editModal.formData.datum}"
                                    oninput="state.editModal.formData.datum = this.value"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus:outline-none"
                                />
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Kategorie</label>
                                    <select
                                        onchange="state.editModal.formData.kategorie = this.value; render();"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus:outline-none"
                                    >
                                        ${state.kategorien.map(kat => `
                                            <option ${state.editModal.formData.kategorie === kat ? 'selected' : ''}>${kat}</option>
                                        `).join('')}
                                    </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Zweck / Beschreibung *</label>
                                <textarea
                                    required
                                    oninput="state.editModal.formData.zweck = this.value"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus:outline-none"
                                    rows="3"
                                >${state.editModal.formData.zweck}</textarea>
                            </div>

                            ${a.historie && a.historie.length > 1 ? `
                                <div class="border-t pt-4 mt-6">
                                    <h3 class="text-sm font-semibold text-gray-700 mb-3">üìú √Ñnderungshistorie</h3>
                                    <div class="space-y-2 max-h-48 overflow-y-auto">
                                        ${a.historie.slice().reverse().map(h => `
                                            <div class="text-xs bg-gray-50 p-3 rounded">
                                                <div class="flex justify-between items-start mb-1">
                                                    <span class="font-semibold text-gray-700">${h.aktion}</span>
                                                    <span class="text-gray-400">${new Date(h.zeitpunkt).toLocaleString('de-DE')}</span>
                                                </div>
                                                <p class="text-gray-500">von ${h.benutzer}</p>
                                                ${h.aenderungen ? `
                                                    <div class="mt-2 space-y-1">
                                                        ${h.aenderungen.map(aen => `
                                                            <div class="text-gray-600">
                                                                <strong>${aen.feld}:</strong> 
                                                                <span class="line-through text-red-500">${aen.alt}</span> 
                                                                ‚Üí <span class="text-green-600">${aen.neu}</span>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="sticky bottom-0 bg-white border-t border-gray-200 p-6 rounded-b-2xl flex gap-3">
                            <button 
                                onclick="closeEditModal()"
                                class="flex-1 py-3 rounded-lg border-2 border-gray-300 text-gray-600 font-semibold hover:bg-gray-50 transition"
                            >
                                Abbrechen
                            </button>
                            <button 
                                onclick="saveEdit()"
                                class="flex-1 py-3 rounded-lg bg-verein-pink hover:bg-verein-pink-dark text-white font-semibold transition"
                            >
                                ‚úì √Ñnderungen speichern
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

function renderReportModal() {
            if (!state.reportModal.open) return '';
            
            const gesamtSumme = state.reportModal.data ? state.reportModal.data.reduce((sum, d) => sum + d.summe, 0) : 0;
            const gesamtAnzahl = state.reportModal.data ? state.reportModal.data.reduce((sum, d) => sum + d.anzahl, 0) : 0;
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" onclick="closeReportModal()">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-screen overflow-y-auto" onclick="event.stopPropagation()">
                        
                        <div class="bg-verein-darkblue text-white p-6 rounded-t-2xl flex justify-between items-center">
                            <div>
                                <h2 class="text-xl font-bold">üìä Auswertung erstellen</h2>
                                <p class="text-cyan-200 text-sm mt-1">Kosten analysieren und exportieren</p>
                            </div>
                            <button onclick="closeReportModal()" class="text-white hover:text-cyan-200 text-2xl font-bold">‚úï</button>
                        </div>

                        <div class="p-6 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Report-Typ</label>
                                    <select
                                        onchange="state.reportModal.typ = this.value; generateReport();"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus:outline-none"
                                    >
                                        <option value="kategorie" ${state.reportModal.typ === 'kategorie' ? 'selected' : ''}>Nach Kategorie</option>
                                        <option value="mitglied" ${state.reportModal.typ === 'mitglied' ? 'selected' : ''}>Nach Mitglied</option>
                                        <option value="monat" ${state.reportModal.typ === 'monat' ? 'selected' : ''}>Nach Monat</option>
                                        <option value="status" ${state.reportModal.typ === 'status' ? 'selected' : ''}>Nach Status</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Von Datum</label>
                                    <input
                                        type="date"
                                        value="${state.reportModal.vonDatum}"
                                        onchange="state.reportModal.vonDatum = this.value; generateReport();"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus:outline-none"
                                    />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Bis Datum</label>
                                    <input
                                        type="date"
                                        value="${state.reportModal.bisDatum}"
                                        onchange="state.reportModal.bisDatum = this.value; generateReport();"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus:outline-none"
                                    />
                                </div>
                            </div>

                            ${state.reportModal.data && state.reportModal.data.length > 0 ? `
                                <div class="border-t pt-4">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-lg font-bold text-gray-800">Vorschau</h3>
                                        <div class="text-right">
                                            <p class="text-sm text-gray-500">Gesamt</p>
                                            <p class="text-xl font-bold text-verein-pink">${gesamtSumme.toFixed(2)} ‚Ç¨</p>
                                            <p class="text-xs text-gray-400">${gesamtAnzahl} Belege</p>
                                        </div>
                                    </div>
                                    
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 w-8"></th>
                                                    ${state.reportModal.typ === 'kategorie' ? '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kategorie</th>' : ''}
                                                    ${state.reportModal.typ === 'mitglied' ? '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Mitglied</th>' : ''}
                                                    ${state.reportModal.typ === 'monat' ? '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Monat</th>' : ''}
                                                    ${state.reportModal.typ === 'status' ? '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Status</th>' : ''}
                                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Anzahl</th>
                                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Summe</th>
                                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Anteil</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-200">
                                                ${state.reportModal.data.map(d => {
                                                    const anteil = (d.summe / gesamtSumme * 100).toFixed(1);
                                                    const isExpanded = state.reportModal.expandedRow === d.key;
                                                    return `
                                                        <tr class="hover:bg-gray-50 cursor-pointer" onclick="toggleReportRow('${d.key.replace(/'/g, "\\'")}')">
                                                            <td class="px-4 py-3 text-sm text-center">
                                                                <span class="text-gray-400">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                                            </td>
                                                            ${state.reportModal.typ === 'kategorie' ? `<td class="px-4 py-3 text-sm font-medium">${d.kategorie}</td>` : ''}
                                                            ${state.reportModal.typ === 'mitglied' ? `<td class="px-4 py-3 text-sm font-medium">${d.mitglied}</td>` : ''}
                                                            ${state.reportModal.typ === 'monat' ? `<td class="px-4 py-3 text-sm font-medium">${d.monat}</td>` : ''}
                                                            ${state.reportModal.typ === 'status' ? `<td class="px-4 py-3 text-sm font-medium">${d.status}</td>` : ''}
                                                            <td class="px-4 py-3 text-sm text-right">${d.anzahl}</td>
                                                            <td class="px-4 py-3 text-sm text-right font-semibold">${d.summe.toFixed(2)} ‚Ç¨</td>
                                                            <td class="px-4 py-3 text-sm text-right">
                                                                <div class="flex items-center justify-end gap-2">
                                                                    <div class="w-16 bg-gray-200 rounded-full h-2">
                                                                        <div class="bg-verein-pink h-2 rounded-full" style="width: ${anteil}%"></div>
                                                                    </div>
                                                                    <span class="text-gray-500">${anteil}%</span>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        ${isExpanded ? `
                                                            <tr>
                                                                <td colspan="7" class="px-0 py-0">
                                                                    <div class="bg-gray-50 px-8 py-4">
                                                                        <p class="text-xs font-semibold text-gray-500 uppercase mb-3">Einzelne Auslagen</p>
                                                                        <div class="space-y-2">
                                                                            ${d.auslagen.map(a => `
                                                                                <div class="bg-white rounded-lg p-3 border border-gray-200 hover:shadow-sm transition">
                                                                                    <div class="flex justify-between items-start">
                                                                                        <div class="flex-1">
                                                                                            <p class="font-medium text-gray-800 text-sm">${a.zweck}</p>
                                                                                            <div class="flex gap-3 mt-1 text-xs text-gray-500">
                                                                                                <span>üìÖ ${a.datum}</span>
                                                                                                <span>üë§ ${a.mitglied}</span>
                                                                                                <span class="px-2 py-0.5 rounded-full ${
                                                                                                    a.status === 'offen' ? 'bg-verein-cyan-light text-verein-cyan' :
                                                                                                    'bg-green-100 text-green-700'
                                                                                                }">
                                                                                                    ${a.status === 'offen' ? '‚è≥ Offen' : '‚úÖ Bezahlt'}
                                                                                                </span>
                                                                                            </div>
                                                                                        </div>
                                                                                        <p class="text-lg font-bold text-verein-pink ml-4">${a.betrag.toFixed(2)} ‚Ç¨</p>
                                                                                    </div>
                                                                                </div>
                                                                            `).join('')}
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        ` : ''}
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ` : `
                                <div class="text-center py-12">
                                    <p class="text-gray-400 text-lg">üìä</p>
                                    <p class="text-gray-500 mt-2">Keine Daten f√ºr diesen Zeitraum</p>
                                </div>
                            `}
                        </div>

                        <div class="sticky bottom-0 bg-white border-t border-gray-200 p-6 rounded-b-2xl flex gap-3">
                            <button 
                                onclick="closeReportModal()"
                                class="flex-1 py-3 rounded-lg border-2 border-gray-300 text-gray-600 font-semibold hover:bg-gray-50 transition"
                            >
                                Schlie√üen
                            </button>
                            <button 
                                onclick="exportReport()"
                                class="flex-1 py-3 rounded-lg bg-green-500 hover:bg-green-600 text-white font-semibold transition ${!state.reportModal.data || state.reportModal.data.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${!state.reportModal.data || state.reportModal.data.length === 0 ? 'disabled' : ''}
                            >
                                üì• Als CSV exportieren
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderKategorienModal() {
            if (!state.kategorienModal.open) return '';
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" onclick="closeKategorienModal()">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-screen overflow-y-auto" onclick="event.stopPropagation()">
                        
                        <div class="bg-verein-darkblue text-white p-6 rounded-t-2xl flex justify-between items-center">
                            <div>
                                <h2 class="text-xl font-bold">Kategorien verwalten</h2>
                                <p class="text-cyan-200 text-sm mt-1">${state.kategorien.length} Kategorien</p>
                            </div>
                            <button onclick="closeKategorienModal()" class="text-white hover:text-cyan-200 text-2xl font-bold">‚úï</button>
                        </div>

                        <div class="p-6">
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Neue Kategorie hinzuf√ºgen</label>
                                <div class="flex gap-2">
                                    <input
                                        type="text"
                                        id="neue-kategorie-input"
                                        placeholder="z.B. Dekoration"
                                        value="${state.kategorienModal.neueKategorie}"
                                        oninput="state.kategorienModal.neueKategorie = this.value"
                                        onkeypress="if(event.key === 'Enter') addKategorie()"
                                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus:outline-none"
                                    />
                                    <button
                                        onclick="addKategorie()"
                                        class="px-4 py-2 bg-verein-pink hover:bg-verein-pink-dark text-white rounded-lg font-semibold transition"
                                    >
                                        + Hinzuf√ºgen
                                    </button>
                                </div>
                            </div>

                            <div class="border-t pt-4">
                                <h3 class="text-sm font-semibold text-gray-700 mb-3">Bestehende Kategorien</h3>
                                <div class="space-y-2 max-h-96 overflow-y-auto">
                                    ${state.kategorien.map(kat => {
                                        const inUse = state.auslagen.some(a => a.kategorie === kat);
                                        return `
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                                <span class="font-medium text-gray-700">${kat}</span>
                                                <div class="flex items-center gap-2">
                                                    ${inUse ? `
                                                        <span class="text-xs text-gray-400 bg-white px-2 py-1 rounded">in Benutzung</span>
                                                    ` : ''}
                                                    <button
                                                        onclick="deleteKategorie('${kat.replace(/'/g, "\\'")}')"
                                                        class="px-3 py-1 ${inUse ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-red-100 text-red-600 hover:bg-red-200'} text-xs rounded transition"
                                                        ${inUse ? 'disabled' : ''}
                                                        title="${inUse ? 'Kategorie wird verwendet' : 'Kategorie l√∂schen'}"
                                                    >
                                                        üóëÔ∏è L√∂schen
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="sticky bottom-0 bg-white border-t border-gray-200 p-6 rounded-b-2xl">
                            <button 
                                onclick="closeKategorienModal()"
                                class="w-full py-3 rounded-lg border-2 border-gray-300 text-gray-600 font-semibold hover:bg-gray-50 transition"
                            >
                                Fertig
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderToast() {
            if (!state.toast) return '';
            return `
                <div class="fixed top-6 left-1/2 -translate-x-1/2 z-50 bg-verein-darkblue text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3">
                    <span class="text-2xl">‚úÖ</span>
                    <p class="font-semibold">${state.toast}</p>
                    <button onclick="state.toast = null; render();" class="ml-4 bg-verein-pink hover:bg-verein-pink-dark px-3 py-1 rounded-lg text-sm font-semibold transition">
                        OK
                    </button>
                </div>
            `;
        }

        function renderModal() {
            if (!state.modal.open) return '';

            const summeAusgewaehlt = state.modal.ausgewaehlt
                .reduce((sum, id) => {
                    const a = state.auslagen.find(a => a.id === id);
                    return sum + (a ? a.betrag : 0);
                }, 0);

            return `
                <div class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" onclick="closeModal()">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-screen overflow-y-auto" onclick="event.stopPropagation()">
                        
                        <div class="bg-verein-darkblue text-white p-6 rounded-t-2xl flex justify-between items-center">
                            <div>
                                <h2 class="text-xl font-bold">Belege von ${state.modal.mitglied}</h2>
                                <p class="text-cyan-200 text-sm mt-1">${state.modal.belegeDesMitglieds.length} offene Positionen</p>
                            </div>
                            <button onclick="closeModal()" class="text-white hover:text-cyan-200 text-2xl font-bold">‚úï</button>
                        </div>

                        <div class="p-6 space-y-4">
                            ${state.modal.belegeDesMitglieds.map(auslage => {
                                const isChecked = state.modal.ausgewaehlt.includes(auslage.id);
                                return `
                                    <div 
                                        onclick="toggleBeleg(${auslage.id})"
                                        class="border-2 rounded-xl p-4 cursor-pointer transition-all ${isChecked ? 'border-verein-pink bg-verein-pink-light' : 'border-gray-200 hover:border-gray-300'}"
                                    >
                                        <div class="flex items-start gap-4">
                                            <div class="mt-1">
                                                <div class="w-6 h-6 rounded border-2 flex items-center justify-center ${isChecked ? 'bg-verein-pink border-verein-pink' : 'border-gray-400'}">
                                                    ${isChecked ? '<span class="text-white text-xs font-bold">‚úì</span>' : ''}
                                                </div>
                                            </div>
                                            <div class="flex-1">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="font-semibold text-gray-800">${auslage.zweck}</p>
                                                        <p class="text-sm text-gray-500">${auslage.kategorie} ‚Ä¢ ${auslage.datum}</p>
                                                        <span class="inline-block mt-1 px-2 py-0.5 rounded-full text-xs bg-cyan-100 text-verein-cyan">
                                                            ‚è≥ Offen
                                                        </span>
                                                    </div>
                                                    <p class="text-xl font-bold text-verein-pink ml-4">${auslage.betrag.toFixed(2)} ‚Ç¨</p>
                                                </div>
                                                ${auslage.beleg ? `
                                                    <img 
                                                        src="${auslage.beleg}" 
                                                        alt="Beleg" 
                                                        class="w-full max-h-48 object-contain rounded-lg mt-3 border border-gray-200"
                                                    />
                                                ` : '<p class="text-xs text-gray-400 mt-2">üìé Kein Beleg hochgeladen</p>'}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        <div class="sticky bottom-0 bg-white border-t border-gray-200 p-6 rounded-b-2xl">
                            <div class="flex justify-between items-center mb-4">
                                <p class="text-gray-600 text-sm">${state.modal.ausgewaehlt.length} von ${state.modal.belegeDesMitglieds.length} ausgew√§hlt</p>
                                <p class="text-2xl font-bold text-verein-pink">${summeAusgewaehlt.toFixed(2)} ‚Ç¨</p>
                            </div>
                            <div class="flex gap-3">
                                <button 
                                    onclick="closeModal()"
                                    class="flex-1 py-3 rounded-lg border-2 border-gray-300 text-gray-600 font-semibold hover:bg-gray-50 transition"
                                >
                                    Abbrechen
                                </button>
                                <button 
                                    onclick="bezahleAusgewaehlt()"
                                    class="flex-1 py-3 rounded-lg font-semibold text-white transition ${state.modal.ausgewaehlt.length === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-verein-pink hover:bg-verein-pink-dark'}"
                                    ${state.modal.ausgewaehlt.length === 0 ? 'disabled' : ''}
                                >
                                    üí∞ ${state.modal.ausgewaehlt.length} Belege bezahlen
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        // Render Functions
        function renderLogin() {
            return `
                <div class="min-h-screen bg-gradient-verein flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <div class="text-center mb-8">
                            <img src="${LOGO_BASE64}" alt="Gut und Aussehend" class="w-48 h-48 mx-auto mb-4 object-contain" />
                            <h2 class="text-2xl font-semibold text-gray-800">Auslagen-Verwaltung</h2>
                        </div>
                        
                        <div class="space-y-4">
                            <input
                                type="text"
                                id="loginName"
                                placeholder="Dein Name"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-verein-pink focus-verein:ring-pink focus:outline-none"
                                onkeypress="if(event.key === 'Enter') document.getElementById('loginMitglied').click()"
                            />
                            
                            <button
                                id="loginMitglied"
                                onclick="handleLogin(document.getElementById('loginName').value, 'mitglied')"
                                class="w-full bg-verein-pink text-white py-3 rounded-lg font-semibold hover:bg-verein-pink-dark focus-verein:ring-pink transition-all"
                            >
                                Als Mitglied anmelden
                            </button>
                            
                            <button
                                onclick="handleLogin(document.getElementById('loginName').value, 'kassenwart')"
                                class="w-full bg-verein-cyan text-white py-3 rounded-lg font-semibold hover:bg-verein-cyan-dark focus-verein:ring-cyan transition-all"
                            >
                                Als Kassenwart anmelden
                            </button>
                        </div>

                        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800"><strong>üí° Tipp:</strong> Daten werden lokal im Browser gespeichert</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNavigation() {
            const isMitglied = state.currentUser.rolle === 'mitglied';
            const isKassenwart = state.currentUser.rolle === 'kassenwart';

            return `
                <div class="bg-gradient-verein text-white p-4 shadow-lg">
                    <div class="max-w-6xl mx-auto flex flex-wrap justify-between items-center gap-4">
                        <div class="flex items-center gap-3">
                            <img src="${LOGO_BASE64}" alt="Logo" class="w-12 h-12 object-contain" />
                            <div>
                                <h1 class="text-2xl font-bold">Auslagen-Verwaltung</h1>
                                <p class="text-cyan-200 text-sm">Angemeldet als: ${state.currentUser.name} (${state.currentUser.rolle === 'kassenwart' ? 'Kassenwart' : 'Mitglied'})</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${isMitglied ? `
                                <button
                                    onclick="state.view = 'meine-auslagen'; render();"
                                    class="px-4 py-2 rounded ${state.view === 'meine-auslagen' ? 'bg-white text-verein-pink' : 'bg-verein-pink hover:bg-verein-pink-dark'}"
                                >
                                    Meine Auslagen
                                </button>
                                <button
                                    onclick="state.view = 'neue-auslage'; render();"
                                    class="px-4 py-2 rounded ${state.view === 'neue-auslage' ? 'bg-white text-verein-pink' : 'bg-verein-pink hover:bg-verein-pink-dark'}"
                                >
                                    + Neue Auslage
                                </button>
                            ` : ''}
                            ${isKassenwart ? `
                                <button
                                    onclick="state.view = 'dashboard'; render();"
                                    class="px-4 py-2 rounded ${state.view === 'dashboard' ? 'bg-white text-verein-pink' : 'bg-verein-pink hover:bg-verein-pink-dark'}"
                                >
                                    Dashboard
                                </button>
                                <button
                                    onclick="openReportModal()"
                                    class="px-4 py-2 rounded bg-blue-500 hover:bg-blue-600"
                                >
                                    üìä Reports
                                </button>
                                <button
                                    onclick="openKategorienModal()"
                                    class="px-4 py-2 rounded bg-verein-cyan hover:bg-verein-cyan-dark"
                                >
                                    üè∑Ô∏è Kategorien
                                </button>
                                <button
                                    onclick="exportCSV()"
                                    class="px-4 py-2 rounded bg-green-500 hover:bg-green-600"
                                >
                                    üì• Export
                                </button>
                            ` : ''}
                            <button
                                onclick="handleLogout()"
                                class="px-4 py-2 rounded bg-red-500 hover:bg-red-600"
                            >
                                Abmelden
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNeueAuslage() {
            return `
                <div class="min-h-screen bg-gray-50">
                    ${renderNavigation()}
                    <div class="max-w-2xl mx-auto p-6">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Neue Auslage erfassen</h2>
                            
                            <form onsubmit="handleSubmit(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Betrag (‚Ç¨) *
                                    </label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        required
                                        value="${state.formData.betrag}"
                                        oninput="state.formData.betrag = this.value"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus-verein:ring-pink focus:outline-none"
                                        placeholder="z.B. 12.50"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Datum *
                                    </label>
                                    <input
                                        type="date"
                                        required
                                        value="${state.formData.datum}"
                                        oninput="state.formData.datum = this.value"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus-verein:ring-pink focus:outline-none"
                                    />
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Kategorie
                                    </label>
                                    <select
                                        value="${state.formData.kategorie}"
                                        onchange="state.formData.kategorie = this.value"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus-verein:ring-pink focus:outline-none"
                                    >
                                        ${state.kategorien.map(kat => `
                                            <option ${state.formData.kategorie === kat ? 'selected' : ''}>${kat}</option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Zweck / Beschreibung *
                                    </label>
                                    <textarea
                                        required
                                        value="${state.formData.zweck}"
                                        oninput="state.formData.zweck = this.value"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-verein-pink focus-verein:ring-pink focus:outline-none"
                                        rows="3"
                                        placeholder="z.B. Stoffe f√ºr Kost√ºme, Getr√§nke f√ºr Festwagen..."
                                    >${state.formData.zweck}</textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Beleg hochladen *
                                    </label>
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                        ${state.formData.beleg ? `
                                            <div>
                                                <img src="${state.formData.beleg}" alt="Beleg" class="max-w-full h-48 mx-auto mb-2 rounded" />
                                                <button
                                                    type="button"
                                                    onclick="removeBeleg()"
                                                    class="text-red-500 text-sm hover:text-red-700"
                                                >
                                                    üóëÔ∏è Entfernen
                                                </button>
                                            </div>
                                        ` : `
                                            <div class="text-gray-500 mb-2">üì∏</div>
                                            <input
                                                type="file"
                                                accept="image/*"
                                                onchange="handleBelegUpload(event)"
                                                class="hidden"
                                                id="beleg-upload"
                                                required
                                            />
                                            <label
                                                for="beleg-upload"
                                                class="cursor-pointer text-verein-pink hover:bg-verein-pink-light px-3 py-1 rounded font-medium transition"
                                            >
                                                Foto ausw√§hlen oder hier klicken
                                            </label>
                                            <p class="text-xs text-gray-500 mt-2">JPG, PNG, max 10MB</p>
                                        `}
                                    </div>
                                </div>

                                <button
                                    type="submit"
                                    class="w-full bg-verein-pink text-white py-3 rounded-lg font-semibold hover:bg-verein-pink-dark focus-verein:ring-pink transition-all"
                                >
                                    Auslage einreichen
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMeineAuslagen() {
            const meineAuslagen = state.auslagen.filter(a => a.mitglied === state.currentUser.name);
            const summeOffen = meineAuslagen.filter(a => a.status === 'offen').reduce((sum, a) => sum + a.betrag, 0);
            const summeBezahlt = meineAuslagen.filter(a => a.status === 'bezahlt').reduce((sum, a) => sum + a.betrag, 0);

            return `
                <div class="min-h-screen bg-gray-50">
                    ${renderNavigation()}
                    <div class="max-w-6xl mx-auto p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Offen</p>
                                        <p class="text-3xl font-bold text-verein-cyan">${summeOffen.toFixed(2)} ‚Ç¨</p>
                                    </div>
                                    <div class="text-4xl">‚è≥</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Bezahlt</p>
                                        <p class="text-3xl font-bold text-green-500">${summeBezahlt.toFixed(2)} ‚Ç¨</p>
                                    </div>
                                    <div class="text-4xl">‚úÖ</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Gesamt</p>
                                        <p class="text-3xl font-bold text-verein-pink">${meineAuslagen.length}</p>
                                    </div>
                                    <div class="text-4xl">üìÑ</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow">
                            <div class="p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Meine Auslagen</h2>
                                
                                ${meineAuslagen.length === 0 ? `
                                    <p class="text-gray-500 text-center py-8">Noch keine Auslagen erfasst</p>
                                ` : `
                                    <div class="space-y-4">
                                        ${meineAuslagen.sort((a, b) => b.id - a.id).map(auslage => `
                                            <div class="border rounded-lg p-4 hover:shadow-md transition">
                                                <div class="flex flex-wrap justify-between items-start mb-2 gap-4">
                                                    <div class="flex-1 min-w-0">
                                                        <h3 class="font-semibold text-lg">${auslage.zweck}</h3>
                                                        <p class="text-sm text-gray-500">${auslage.kategorie} ‚Ä¢ ${auslage.datum}</p>
                                                    </div>
                                                    <div class="text-right">
                                                        <p class="text-2xl font-bold text-verein-pink">${auslage.betrag.toFixed(2)} ‚Ç¨</p>
                                                        <span class="inline-block px-3 py-1 rounded-full text-sm font-medium ${
                                                            auslage.status === 'offen' ? 'bg-verein-cyan-light text-verein-cyan' :
                                                            'bg-green-100 text-green-700'
                                                        }">
                                                            ${auslage.status === 'offen' ? '‚è≥ Offen' : '‚úÖ Bezahlt'}
                                                        </span>
                                                    </div>
                                                </div>
                                                ${auslage.beleg ? `
                                                    <img 
                                                        src="${auslage.beleg}" 
                                                        alt="Beleg" 
                                                        class="w-32 h-32 object-cover rounded mt-2 cursor-pointer hover:opacity-80" 
                                                        onclick="viewBeleg(${auslage.id})"
                                                    />
                                                ` : ''}
                                                ${auslage.status === 'offen' ? `
                                                    <div class="mt-3 flex gap-2">
                                                        <button
                                                            onclick="openEditModal(${auslage.id})"
                                                            class="px-3 py-1 bg-blue-100 text-blue-600 text-xs rounded hover:bg-blue-200 transition"
                                                        >
                                                            ‚úèÔ∏è Bearbeiten
                                                        </button>
                                                        <button
                                                            onclick="deleteAuslage(${auslage.id})"
                                                            class="px-3 py-1 bg-red-100 text-red-600 text-xs rounded hover:bg-red-200 transition"
                                                        >
                                                            üóëÔ∏è L√∂schen
                                                        </button>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const offeneAuslagen = state.auslagen.filter(a => a.status === 'offen');
            const bezahlteAuslagen = state.auslagen.filter(a => a.status === 'bezahlt');
            
            const summeOffen = offeneAuslagen.reduce((sum, a) => sum + a.betrag, 0);
            const summeBezahlt = bezahlteAuslagen.reduce((sum, a) => sum + a.betrag, 0);
            const KASSENBESTAND = 5000.00;
            const kassenbestandAktuell = KASSENBESTAND - summeBezahlt;
            const kassenbestandNachAbzug = kassenbestandAktuell - summeOffen;

            return `
                <div class="min-h-screen bg-gray-50">
                    ${renderNavigation()}
                    <div class="max-w-6xl mx-auto p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Offen</p>
                                        <p class="text-2xl font-bold text-verein-cyan">${summeOffen.toFixed(2)} ‚Ç¨</p>
                                        <p class="text-gray-400 text-xs">${offeneAuslagen.length} Positionen</p>
                                    </div>
                                    <div class="text-3xl">‚è≥</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Bezahlt</p>
                                        <p class="text-2xl font-bold text-green-500">${summeBezahlt.toFixed(2)} ‚Ç¨</p>
                                        <p class="text-gray-400 text-xs">${bezahlteAuslagen.length} Positionen</p>
                                    </div>
                                    <div class="text-3xl">‚úÖ</div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Gesamt</p>
                                        <p class="text-2xl font-bold text-verein-pink">${state.auslagen.length}</p>
                                        <p class="text-gray-400 text-xs">Alle Auslagen</p>
                                    </div>
                                    <div class="text-3xl">üìä</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-verein-darkblue rounded-lg shadow p-6 relative">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <p class="text-cyan-200 text-sm">Kassenbestand aktuell</p>
                                            <span class="text-cyan-400 text-xs cursor-help relative group">‚ÑπÔ∏è
                                                <div class="absolute top-6 left-0 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 hidden group-hover:block z-10 whitespace-nowrap shadow-lg">
                                                    Anfangsbestand: ${KASSENBESTAND.toFixed(2)} ‚Ç¨
                                                </div>
                                            </span>
                                        </div>
                                        <p class="text-3xl font-bold text-white">${kassenbestandAktuell.toFixed(2)} ‚Ç¨</p>
                                        <p class="text-cyan-300 text-xs mt-1">bereits bezahlt: ${summeBezahlt.toFixed(2)} ‚Ç¨</p>
                                    </div>
                                    <div class="text-3xl">üè¶</div>
                                </div>
                            </div>
                            <div class="rounded-lg shadow p-6 ${kassenbestandNachAbzug < 0 ? 'bg-red-600' : 'bg-verein-pink'}">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-pink-100 text-sm">Kasse nach offenen Abz√ºgen</p>
                                        <p class="text-3xl font-bold text-white">${kassenbestandNachAbzug.toFixed(2)} ‚Ç¨</p>
                                        <p class="text-pink-200 text-xs mt-1">Abzug: ${summeOffen.toFixed(2)} ‚Ç¨</p>
                                    </div>
                                    <div class="text-3xl">${kassenbestandNachAbzug < 0 ? '‚ö†Ô∏è' : '‚úÖ'}</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                            <div class="p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">üí∏ Auszahlungen je Mitglied</h2>
                                ${(() => {
                                    const zuBezahlen = state.auslagen.filter(a => a.status === 'offen');
                                    const nachMitglied = zuBezahlen.reduce((acc, a) => {
                                        if (!acc[a.mitglied]) acc[a.mitglied] = { summe: 0 };
                                        acc[a.mitglied].summe += a.betrag;
                                        return acc;
                                    }, {});
                                    
                                    if (Object.keys(nachMitglied).length === 0) {
                                        return '<p class="text-gray-500 text-center py-4">Keine offenen Auszahlungen</p>';
                                    }
                                    
                                    return '<div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-50"><tr>' +
                                        '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Mitglied</th>' +
                                        '<th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Auszuzahlen</th>' +
                                        '</tr></thead><tbody class="divide-y divide-gray-200">' +
                                        Object.entries(nachMitglied)
                                            .sort((a, b) => b[1].summe - a[1].summe)
                                            .map(([name, betraege]) => {
                                                return `<tr class="hover:bg-gray-50 cursor-pointer" onclick="openBelegModal('${name}')">
                                                    <td class="px-4 py-3 text-sm font-medium">${name}</td>
                                                    <td class="px-4 py-3 text-sm text-right font-bold text-verein-pink">${betraege.summe.toFixed(2)} ‚Ç¨</td>
                                                </tr>`;
                                            }).join('') +
                                        '</tbody></table></div>';
                                })()}
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="p-6">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Alle Auslagen</h2>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                                    <input
                                        type="text"
                                        id="filter-mitglied"
                                        placeholder="üîç Mitglied suchen..."
                                        value="${state.filter.mitglied}"
                                        oninput="state.filter.mitglied = this.value; debounceRender();"
                                        class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-verein-pink focus:outline-none"
                                    />
                                    <select
                                        onchange="state.filter.status = this.value; debounceRender(0);"
                                        class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-verein-pink focus:outline-none"
                                    >
                                        <option value="" ${state.filter.status === '' ? 'selected' : ''}>Alle Status</option>
                                        <option value="offen" ${state.filter.status === 'offen' ? 'selected' : ''}>‚è≥ Offen</option>
                                        <option value="bezahlt" ${state.filter.status === 'bezahlt' ? 'selected' : ''}>‚úÖ Bezahlt</option>
                                    </select>
                                    <select
                                        onchange="state.filter.kategorie = this.value; debounceRender(0);"
                                        class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-verein-pink focus:outline-none"
                                    >
                                        <option value="" ${state.filter.kategorie === '' ? 'selected' : ''}>Alle Kategorien</option>
                                        ${state.kategorien.map(kat => `
                                            <option value="${kat}" ${state.filter.kategorie === kat ? 'selected' : ''}>${kat}</option>
                                        `).join('')}
                                    </select>
                                </div>

                                ${(() => {
                                    const gefiltert = state.auslagen
                                        .filter(a => 
                                            (state.filter.mitglied === '' || a.mitglied.toLowerCase().includes(state.filter.mitglied.toLowerCase())) &&
                                            (state.filter.status === '' || a.status === state.filter.status) &&
                                            (state.filter.kategorie === '' || a.kategorie === state.filter.kategorie)
                                        )
                                        .sort((a, b) => b.id - a.id);

                                    if (state.auslagen.length === 0) {
                                        return '<p class="text-gray-500 text-center py-8">Noch keine Auslagen vorhanden</p>';
                                    }
                                    if (gefiltert.length === 0) {
                                        return '<p class="text-gray-500 text-center py-8">Keine Auslagen f√ºr diesen Filter gefunden</p>';
                                    }

                                    return `
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Datum</th>
                                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Mitglied</th>
                                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Zweck</th>
                                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Kategorie</th>
                                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Betrag</th>
                                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Beleg</th>
                                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Status</th>
                                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Aktionen</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-200">
                                                ${gefiltert.map(auslage => `
                                                    <tr class="hover:bg-gray-50">
                                                        <td class="px-4 py-3 text-sm">${auslage.datum}</td>
                                                        <td class="px-4 py-3 text-sm font-medium">${auslage.mitglied}</td>
                                                        <td class="px-4 py-3 text-sm">${auslage.zweck}</td>
                                                        <td class="px-4 py-3 text-sm text-gray-500">${auslage.kategorie}</td>
                                                        <td class="px-4 py-3 text-sm text-right font-semibold">${auslage.betrag.toFixed(2)} ‚Ç¨</td>
                                                        <td class="px-4 py-3 text-center">
                                                            ${auslage.beleg ? `
                                                                <button
                                                                    onclick="viewBeleg(${auslage.id})"
                                                                    class="text-verein-pink hover:text-verein-pink-dark text-sm"
                                                                >
                                                                    üìÑ Ansehen
                                                                </button>
                                                            ` : '-'}
                                                        </td>
                                                        <td class="px-4 py-3 text-center">
                                                            <span class="inline-block px-3 py-1 rounded-full text-xs font-medium ${
                                                                auslage.status === 'offen' ? 'bg-verein-cyan-light text-verein-cyan' :
                                                                auslage.status === 'gepr√ºft' ? 'bg-verein-pink-light text-verein-pink' :
                                                                'bg-green-100 text-green-700'
                                                            }">
                                                                ${auslage.status}
                                                            </span>
                                                        </td>
                                                        <td class="px-4 py-3 text-center">
                                                            <div class="flex gap-1 justify-center flex-wrap">
                                                                ${auslage.status === 'offen' ? `
                                                                    <button
                                                                        onclick="updateStatus(${auslage.id}, 'bezahlt')"
                                                                        class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600"
                                                                        title="Als bezahlt markieren"
                                                                    >
                                                                        üí∞ Bezahlen
                                                                    </button>
                                                                ` : ''}
                                                                <button
                                                                    onclick="openEditModal(${auslage.id})"
                                                                    class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded hover:bg-yellow-200"
                                                                    title="Auslage bearbeiten"
                                                                >
                                                                    ‚úèÔ∏è
                                                                </button>
                                                                <button
                                                                    onclick="deleteAuslage(${auslage.id})"
                                                                    class="px-2 py-1 bg-red-100 text-red-600 text-xs rounded hover:bg-red-200"
                                                                    title="Auslage l√∂schen"
                                                                >
                                                                    üóëÔ∏è
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>`;
                                })()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Main Render Function
        function render() {
            const scrollPos = window.scrollY;
            const activeEl = document.activeElement;
            const activeId = activeEl ? activeEl.id : null;
            const cursorPos = activeEl && activeEl.selectionStart !== undefined ? activeEl.selectionStart : null;
            const app = document.getElementById('app');
            if (!state.currentUser) {
                app.innerHTML = renderLogin() + renderToast();
            } else if (state.view === 'neue-auslage') {
                app.innerHTML = renderNeueAuslage() + renderEditModal() + renderBelegOverlay() + renderToast();
            } else if (state.view === 'meine-auslagen') {
                app.innerHTML = renderMeineAuslagen() + renderEditModal() + renderBelegOverlay() + renderToast();
            } else if (state.view === 'dashboard') {
                app.innerHTML = renderDashboard() + renderModal() + renderReportModal() + renderKategorienModal() + renderEditModal() + renderBelegOverlay() + renderToast();
            }
            
            // Scroll-Position und Fokus wiederherstellen
            setTimeout(() => {
                window.scrollTo(0, scrollPos);
                if (activeId) {
                    const el = document.getElementById(activeId);
                    if (el) {
                        el.focus();
                        if (cursorPos !== null && el.setSelectionRange) {
                            el.setSelectionRange(cursorPos, cursorPos);
                        }
                    }
                }
            }, 0);
        }
        // Initialize App
        loadData();
        render();
    </script>
</body>
</html>
